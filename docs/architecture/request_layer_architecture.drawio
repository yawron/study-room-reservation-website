<?xml version="1.0" encoding="UTF-8"?>
<mxfile host="app.diagrams.net" modified="2024-05-22T12:10:00.000Z" agent="Trae AI" etag="request-layer-arch-v2" version="21.0.0" type="device">
  <diagram name="RequestLayer Architecture" id="request-layer-arch-id">
    <mxGraphModel dx="1422" dy="794" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1169" pageHeight="827" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        
        <!-- 背景容器：RequestLayer -->
        <mxCell id="main_container" value="RequestLayer (Axios 封装核心)" style="swimlane;whiteSpace=wrap;html=1;startSize=30;fillColor=#f5f5f5;strokeColor=#666666;fontStyle=1;fontSize=14;" vertex="1" parent="1">
          <mxGeometry x="40" y="40" width="1120" height="920" as="geometry" />
        </mxCell>

        <!-- 1. 基础配置层 (蓝色) -->
        <mxCell id="config_layer" value="基础配置层 (Configuration)" style="swimlane;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;startSize=30;rounded=1;" vertex="1" parent="main_container">
          <mxGeometry x="40" y="50" width="300" height="220" as="geometry" />
        </mxCell>
        <mxCell id="config_items" value="baseURL: '/api'&#xa;timeout: 15000ms&#xa;withCredentials: true&#xa;headers: {'Content-Type': 'json'}" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;spacing=10;fontSize=12;" vertex="1" parent="config_layer">
          <mxGeometry x="10" y="40" width="280" height="160" as="geometry" />
        </mxCell>

        <!-- 2. 拦截器逻辑 (绿色) -->
        <mxCell id="interceptor_layer" value="拦截器流水线 (Interceptors Pipeline)" style="swimlane;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;startSize=30;rounded=1;" vertex="1" parent="main_container">
          <mxGeometry x="380" y="50" width="700" height="380" as="geometry" />
        </mxCell>
        
        <!-- 请求拦截器 -->
        <mxCell id="req_interceptor" value="请求拦截器 (Request Interceptor)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontStyle=1;" vertex="1" parent="interceptor_layer">
          <mxGeometry x="40" y="50" width="280" height="80" as="geometry" />
        </mxCell>
        <mxCell id="req_action" value="1. 从内存获取 Token (getAccessToken)&#xa;2. 注入 Header: Authorization: Bearer ..." style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;spacingLeft=10;" vertex="1" parent="req_interceptor">
          <mxGeometry x="0" y="25" width="280" height="50" as="geometry" />
        </mxCell>

        <!-- Axios 发送 -->
        <mxCell id="axios_send" value="Axios Core Send" style="shape=process;whiteSpace=wrap;html=1;backgroundOutline=1;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="interceptor_layer">
          <mxGeometry x="380" y="60" width="160" height="60" as="geometry" />
        </mxCell>

        <!-- 响应拦截器 -->
        <mxCell id="res_interceptor" value="响应拦截器 (Response Interceptor)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontStyle=1;" vertex="1" parent="interceptor_layer">
          <mxGeometry x="40" y="170" width="620" height="190" as="geometry" />
        </mxCell>
        
        <!-- 响应分支 -->
        <mxCell id="res_success" value="HTTP 200&#xa;&amp; Code 200" style="rhombus;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#000000;" vertex="1" parent="res_interceptor">
          <mxGeometry x="40" y="50" width="140" height="80" as="geometry" />
        </mxCell>
        <mxCell id="res_unpack" value="数据解包&#xa;return res.data.data" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="res_interceptor">
          <mxGeometry x="240" y="50" width="160" height="80" as="geometry" />
        </mxCell>
        <mxCell id="res_biz_err" value="Code != 200" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="res_interceptor">
          <mxGeometry x="40" y="150" width="140" height="30" as="geometry" />
        </mxCell>
        <mxCell id="res_http_err" value="HTTP 401&#xa;(Unauthorized)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontStyle=1;" vertex="1" parent="res_interceptor">
          <mxGeometry x="440" y="50" width="140" height="80" as="geometry" />
        </mxCell>

        <!-- 连线 -->
        <mxCell id="link_req_send" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="interceptor_layer" source="req_interceptor" target="axios_send">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="link_success" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="res_interceptor" source="res_success" target="res_unpack">
          <mxGeometry relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="link_biz_err" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="res_interceptor" source="res_success" target="res_biz_err">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- 3. 安全与令牌管理 (橙色) -->
        <mxCell id="token_layer" value="安全与令牌管理 (Security &amp; Token)" style="swimlane;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;startSize=30;rounded=1;" vertex="1" parent="main_container">
          <mxGeometry x="380" y="460" width="700" height="420" as="geometry" />
        </mxCell>

        <mxCell id="refresh_flow" value="Token 自动刷新流程" style="group" vertex="1" parent="token_layer">
          <mxGeometry x="30" y="50" width="640" height="340" as="geometry" />
        </mxCell>
        
        <mxCell id="check_refreshing" value="isRefreshing?" style="rhombus;whiteSpace=wrap;html=1;fillColor=#ffffff;" vertex="1" parent="refresh_flow">
          <mxGeometry x="220" y="20" width="120" height="70" as="geometry" />
        </mxCell>
        
        <mxCell id="queue_requests" value="请求入队&#xa;requestsQueue.push(cb)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="refresh_flow">
          <mxGeometry x="420" y="25" width="180" height="60" as="geometry" />
        </mxCell>
        
        <mxCell id="do_refresh" value="发起刷新 (refreshToken)&#xa;独立 Axios 实例" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;fontStyle=1;" vertex="1" parent="refresh_flow">
          <mxGeometry x="200" y="130" width="160" height="60" as="geometry" />
        </mxCell>

        <mxCell id="refresh_success" value="刷新成功?" style="rhombus;whiteSpace=wrap;html=1;fillColor=#ffffff;" vertex="1" parent="refresh_flow">
          <mxGeometry x="220" y="220" width="120" height="70" as="geometry" />
        </mxCell>

        <mxCell id="update_token" value="1. 更新内存 Token&#xa;2. 执行队列请求&#xa;3. 重试当前请求" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;align=left;spacingLeft=10;" vertex="1" parent="refresh_flow">
          <mxGeometry x="420" y="215" width="180" height="80" as="geometry" />
        </mxCell>
        
        <mxCell id="session_expired" value="会话失效处理&#xa;handleSessionExpired()" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontStyle=1;" vertex="1" parent="refresh_flow">
          <mxGeometry x="20" y="225" width="160" height="60" as="geometry" />
        </mxCell>

        <!-- 跨层连接 -->
        <mxCell id="link_401_flow" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" edge="1" parent="main_container" source="res_http_err" target="check_refreshing">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <mxCell id="link_is_refreshing_yes" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="refresh_flow" source="check_refreshing" target="queue_requests">
          <mxGeometry relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="link_is_refreshing_no" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="refresh_flow" source="check_refreshing" target="do_refresh">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="link_refresh_result" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="refresh_flow" source="do_refresh" target="refresh_success">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="link_refresh_ok" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="refresh_flow" source="refresh_success" target="update_token">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="link_refresh_fail" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="refresh_flow" source="refresh_success" target="session_expired">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- 4. 异常处理体系 (红色) -->
        <mxCell id="error_layer" value="异常处理体系 (Error Handling)" style="swimlane;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;startSize=30;rounded=1;" vertex="1" parent="main_container">
          <mxGeometry x="40" y="300" width="300" height="580" as="geometry" />
        </mxCell>
        
        <mxCell id="api_error_class" value="Class ApiError" style="swimlane;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=#ffffff;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;" vertex="1" parent="error_layer">
          <mxGeometry x="30" y="60" width="240" height="100" as="geometry" />
        </mxCell>
        <mxCell id="err_fields" value="+ code: number&#xa;+ message: string&#xa;+ data: any" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" vertex="1" parent="api_error_class">
          <mxGeometry y="26" width="240" height="74" as="geometry" />
        </mxCell>

        <mxCell id="clean_action" value="Session 清理动作" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="error_layer">
          <mxGeometry x="30" y="220" width="240" height="60" as="geometry" />
        </mxCell>
        <mxCell id="clean_detail" value="1. clearAccessToken()&#xa;2. localStorage.removeItem()&#xa;3. window.location.href = '/login'" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;" vertex="1" parent="error_layer">
          <mxGeometry x="30" y="290" width="240" height="100" as="geometry" />
        </mxCell>
        
        <mxCell id="link_expire_clean" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=1;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="main_container" source="session_expired" target="clean_action">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="360" y="715" />
              <mxPoint x="360" y="550" />
            </Array>
          </mxGeometry>
        </mxCell>

      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
